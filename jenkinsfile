pipeline {
    agent any

    stages {
        stage('gitclone') {
            steps {
                git url: "https://github.com/Gerardbulky/install-grafana-usx-ansible.git", branch: "main"
                echo "Workspace Path: ${WORKSPACE}/deployment.yaml"
            }
        }
        stage('Docker Build') {
            steps {
                sh "docker build -t bossmanjerry/vault-images:${env.BUILD_NUMBER} ."
            }
        }
        stage('Docker Push') {
            steps {
                //Logging into vault
                withVault(configuration: [disableChildPoliciesOverride: false, timeout: 60, vaultCredentialId: 'vault-jenkins-role', vaultUrl: 'http://16.16.67.55:8200'], vaultSecrets: [[path: 'secrets/creds/my-secret-text', secretValues: [[vaultKey: 'username'], [vaultKey: 'password']]]]) {
                    sh 'docker login -u $username -p $password'
                }
                sh "docker push bossmanjerry/vault-images:${env.BUILD_NUMBER}"
            }
        }
        stage('Update Manifest') {
            steps {
                script {
                    withVault(configuration: [disableChildPoliciesOverride: false, timeout: 60, vaultCredentialId: 'vault-jenkins-role', vaultUrl: 'http://16.16.67.55'], vaultSecrets: [[path: 'secrets/creds/my-secret-text', secretValues: [[vaultKey: 'github-username'], [vaultKey: 'github-password']]]]) {
                        sh "git config user.email gerardambe@yahoo.com"
                        sh "git config user.name Gerardbulky"
                        
                        //sh "cat deployment.yaml"
                        sh "sed -i 's+bossmanjerry/vault-images.*+bossmanjerry/vault-images:${env.BUILD_NUMBER}+g' deployment.yaml"
                        //sh "cat deployment.yaml"
                        
                        sh "git add ."
                        sh "git commit -m 'Changed github manifest file: ${env.BUILD_NUMBER}'"
                    
                        // Push changes to GitHub using retrieved credentials
                        sh "git push origin main"
                    }
                }
            }
        }
        
    }
}
